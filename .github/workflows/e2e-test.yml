name: E2E Tests

on:
  workflow_run:
    workflows: ["Deploy PR to fal"]
    types:
      - completed

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    # Only run if the fal deployment succeeded
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Get deployment info
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            // Get the workflow run that triggered us
            const { data: triggeringRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            // Get the jobs from that run to extract outputs
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            // Find the deploy job and get its outputs
            const deployJob = jobs.jobs.find(j => j.name === 'deploy-pr');
            
            if (!deployJob) {
              core.setFailed('Could not find deploy-pr job');
              return;
            }
            
            // We need to get outputs from the run itself
            // Unfortunately, workflow_run events don't directly expose job outputs
            // So we'll reconstruct the values
            
            // Get the PR number from the head branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${triggeringRun.head_branch}`,
              state: 'open'
            });
            
            if (prs.length === 0) {
              core.setFailed('No open PR found');
              return;
            }
            
            const prNumber = prs[0].number;
            const shortSha = triggeringRun.head_sha.substring(0, 7);
            const falAppId = `livepeer/scope-pr-${prNumber}`;
            const falWsUrl = `wss://fal.run/${falAppId}/ws`;
            
            core.setOutput('pr_number', prNumber);
            core.setOutput('head_sha', triggeringRun.head_sha);
            core.setOutput('fal_app_id', falAppId);
            core.setOutput('fal_ws_url', falWsUrl);
            
            console.log(`PR: #${prNumber}`);
            console.log(`fal App: ${falAppId}`);
            console.log(`WebSocket: ${falWsUrl}`);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.deployment.outputs.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: e2e/package-lock.json

      - name: Install dependencies
        working-directory: e2e
        run: npm ci

      - name: Install Playwright browsers
        working-directory: e2e
        run: npx playwright install --with-deps chromium

      - name: Wait for fal deployment to be ready
        env:
          FAL_WS_URL: ${{ steps.deployment.outputs.fal_ws_url }}
        run: |
          echo "Waiting for fal deployment to be ready..."
          echo "Endpoint: $FAL_WS_URL"
          
          # Wait up to 5 minutes for the deployment to be ready
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Try to connect with a simple WebSocket check
            # We'll use a Node.js one-liner for this
            if node -e "
              const ws = require('ws');
              const socket = new ws('${FAL_WS_URL}');
              socket.on('open', () => { 
                console.log('Connected!');
                socket.close();
                process.exit(0);
              });
              socket.on('error', (e) => {
                console.error('Error:', e.message);
                process.exit(1);
              });
              setTimeout(() => {
                console.error('Timeout');
                process.exit(1);
              }, 10000);
            " 2>&1; then
              echo "✅ Deployment is ready!"
              exit 0
            fi
            
            echo "Deployment not ready yet, waiting 10s..."
            sleep 10
          done
          
          echo "❌ Deployment did not become ready in time"
          exit 1

      - name: Run Playwright tests
        working-directory: e2e
        env:
          FAL_WS_URL: ${{ steps.deployment.outputs.fal_ws_url }}
          FAL_APP_ID: ${{ steps.deployment.outputs.fal_app_id }}
          DAYDREAM_TEST_EMAIL: ${{ secrets.DAYDREAM_TEST_EMAIL }}
          DAYDREAM_TEST_PASSWORD: ${{ secrets.DAYDREAM_TEST_PASSWORD }}
          DAYDREAM_BASE_URL: ${{ secrets.DAYDREAM_BASE_URL || 'https://app.daydream.live' }}
        run: |
          npx playwright test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-pr-${{ steps.deployment.outputs.pr_number }}
          path: e2e/playwright-report/
          retention-days: 30

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-artifacts-pr-${{ steps.deployment.outputs.pr_number }}
          path: |
            e2e/test-results/
          retention-days: 7

      - name: Comment test results on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.deployment.outputs.pr_number }};
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const conclusion = '${{ job.status }}';
            
            const statusEmoji = conclusion === 'success' ? '✅' : '❌';
            const statusText = conclusion === 'success' ? 'passed' : 'failed';
            
            const body = `## ${statusEmoji} E2E Tests ${statusText}
            
            | | |
            |---|---|
            | **Status** | ${statusText} |
            | **fal Endpoint** | \`${{ steps.deployment.outputs.fal_app_id }}\` |
            | **Run** | [View logs](${runUrl}) |
            
            ${conclusion !== 'success' ? '### Test Artifacts\nCheck the workflow run for screenshots and traces.' : ''}
            `;
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('E2E Tests')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
